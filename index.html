<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Localhost</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #2c3e50;
            color: white;
            margin: 0;
            padding: 20px;
            overflow: hidden; /* Disable scrollbar */
        }
        
        h1 {
            color: #ecf0f1;
            margin-bottom: 20px;
        }
        
        #gameContainer {
            position: relative;
            border: 3px solid #34495e;
            background-color: #1a252f;
            margin: 20px 0;
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        
        #gameCanvas {
            display: block;
            background-color: #0f1419;
        }
        
        #chatContainer {
            width: 300px;
            display: flex;
            flex-direction: column;
            background-color: #2c3e50;
            border-radius: 5px;
            padding: 10px;
        }
        
        #leftPanel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        #playerList {
            width: 280px;
            padding: 15px;
            background-color: #34495e;
            border-radius: 5px;
            min-height: 300px;
        }
        
        #leaderboard {
            width: 280px;
            padding: 15px;
            background-color: #2c3e50;
            border-radius: 5px;
            min-height: 200px;
        }
        
        #leaderboard h3 {
            margin-top: 0;
            color: #f39c12;
            font-size: 16px;
            border-bottom: 1px solid #34495e;
            padding-bottom: 10px;
        }
        
        #leaderboardList div {
            padding: 5px 0;
            border-bottom: 1px solid #34495e;
            font-size: 14px;
            word-wrap: break-word;
        }
        
        #leaderboardList div:last-child {
            border-bottom: none;
        }
        
        #voteControls {
            text-align: center;
        }
        
        #voteControls button {
            width: 100%;
            margin: 5px 0;
            padding: 8px 16px;
            font-size: 14px;
        }
        
        #playerList h3 {
            margin-top: 0;
            color: #ecf0f1;
            font-size: 16px;
            border-bottom: 1px solid #2c3e50;
            padding-bottom: 10px;
        }
        
        #players div {
            padding: 8px 0;
            border-bottom: 1px solid #2c3e50;
            font-size: 14px;
            word-wrap: break-word;
        }
        
        #players div:last-child {
            border-bottom: none;
        }
        
        #chatMessages {
            flex: 1;
            height: 400px;
            overflow-y: auto;
            background-color: #1a252f;
            border: 1px solid #34495e;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            color: white;
            font-size: 14px;
        }
        
        .chat-message {
            margin-bottom: 5px;
            word-wrap: break-word;
        }
        
        .chat-system {
            color: #f39c12;
            font-style: italic;
        }
        
        .chat-player {
            color: #3498db;
        }
        
        #chatInput {
            width: 100%;
            padding: 8px;
            border: 1px solid #34495e;
            border-radius: 3px;
            background-color: #1a252f;
            color: white;
            font-size: 14px;
        }
        
        #chatInput:focus {
            outline: none;
            border-color: #3498db;
        }
        
        #nameModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        #nameForm {
            background-color: #2c3e50;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #34495e;
        }
        
        #nameInput {
            width: 250px;
            padding: 12px;
            margin: 15px 0;
            border: 1px solid #34495e;
            border-radius: 5px;
            background-color: #1a252f;
            color: white;
            font-size: 16px;
            text-align: center;
        }
        
        #nameInput:focus {
            outline: none;
            border-color: #3498db;
        }
        
        #joinButton {
            padding: 12px 24px;
            font-size: 16px;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        #joinButton:hover {
            background-color: #219a52;
        }
        
        #joinButton:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
        }
        
        #controls {
            margin: 20px 0;
            text-align: center;
        }
        
        #foodLegend {
            background-color: #1a252f;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border: 1px solid #34495e;
        }
        
        #foodLegend h4 {
            margin: 0 0 8px 0;
            color: #f39c12;
            font-size: 14px;
        }
        
        .food-type {
            margin: 3px 0;
            font-size: 12px;
            color: white;
        }
        
        button {
            padding: 12px 24px;
            font-size: 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
        }
        
        #gameInfo {
            display: flex;
            gap: 30px;
            margin: 10px 0;
            font-size: 18px;
        }
        
        #status {
            margin: 10px 0;
            font-size: 16px;
            color: #e74c3c;
        }
        
        #connectionStatus {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .connected {
            background-color: #27ae60;
        }
        
        .disconnected {
            background-color: #e74c3c;
        }
    </style>
</head>
<body>
    <!-- Name Modal -->
    <div id="nameModal">
        <div id="nameForm">
            <h2>üêç Snake Game Multiplayer</h2>
            <p>Nh·∫≠p t√™n c·ªßa b·∫°n ƒë·ªÉ tham gia game:</p>
            <input type="text" id="nameInput" placeholder="T√™n c·ªßa b·∫°n" maxlength="20" />
            <br>
            <button id="joinButton">Tham gia Game</button>
        </div>
    </div>

    <h1>üêç Snake Game Multiplayer</h1>
    
    <div id="connectionStatus" class="disconnected">Ch·ªù k·∫øt n·ªëi...</div>
    
    <div id="status">Ch·ªù nh·∫≠p t√™n...</div>
    
    <div id="gameContainer">
        <div id="leftPanel">
            <div id="playerList">
                <h3>Danh s√°ch ng∆∞·ªùi ch∆°i:</h3>
                <div id="players"></div>
                <div id="voteControls" style="margin-top: 15px;">
                    <button id="voteButton" disabled>Vote ƒë·ªÉ b·∫Øt ƒë·∫ßu</button>
                    <button id="startButton" disabled style="display: none;">B·∫Øt ƒë·∫ßu Game</button>
                    <button id="restartButton" style="display: none;">Ch∆°i l·∫°i</button>
                </div>
                <div id="voteStatus" style="display: none; margin-top: 10px;">
                    <div>Votes: <span id="voteCount">0</span>/<span id="totalPlayers">0</span></div>
                    <div>C·∫ßn th√™m <span id="votesNeeded">0</span> vote ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>
                </div>
            </div>
            
            <div id="leaderboard">
                <h3>üèÜ B·∫£ng x·∫øp h·∫°ng:</h3>
                <div id="leaderboardList"></div>
            </div>
        </div>
        <canvas id="gameCanvas" width="1000" height="700"></canvas>
        <div id="chatContainer">
            <h4>üí¨ Chat</h4>
            <div id="chatMessages"></div>
            <input type="text" id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn..." maxlength="100" />
            <div id="foodLegend">
                <h4>üçé Lo·∫°i th·ª©c ƒÉn:</h4>
                <div class="food-type"><span style="color: #e74c3c;">üî¥ ƒê·ªè:</span> +1 ƒë·ªô d√†i</div>
                <div class="food-type"><span style="color: #ffffff;">‚ö™ Tr·∫Øng:</span> +10 ƒë·ªô d√†i</div>
                <div class="food-type"><span style="color: #9b59b6;">üü£ T√≠m:</span> TƒÉng t·ªëc 5s</div>
                <div class="food-type"><span style="color: #34495e;">‚ö´ ƒêen:</span> +20 ƒë·ªô d√†i</div>
                <div class="food-type"><span style="color: #95a5a6;">üîò X√°m:</span> Gi·∫£m t·ªëc 80% trong 5s</div>
                <div class="food-type"><span style="color: #FFFF00;">üü° V√†ng:</span> T·∫°o ra 50 th·ª©c ƒÉn</div>
            </div>
        </div>
    </div>
    
    <div id="gameInfo">
        <div>Ng∆∞·ªùi ch∆°i: <span id="playerCount">0</span></div>
        <div>T·ªïng ƒëi·ªÉm: <span id="myScore">0</span></div>
    </div>
    
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startButton = document.getElementById('startButton');
        const voteButton = document.getElementById('voteButton');
        const restartButton = document.getElementById('restartButton');
        const statusDiv = document.getElementById('status');
        const playerCountSpan = document.getElementById('playerCount');
        const myScoreSpan = document.getElementById('myScore');
        const playersDiv = document.getElementById('players');
        const leaderboardList = document.getElementById('leaderboardList');
        const connectionStatus = document.getElementById('connectionStatus');
        const nameModal = document.getElementById('nameModal');
        const nameInput = document.getElementById('nameInput');
        const joinButton = document.getElementById('joinButton');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const voteStatus = document.getElementById('voteStatus');
        const voteCount = document.getElementById('voteCount');
        const totalPlayers = document.getElementById('totalPlayers');
        const votesNeeded = document.getElementById('votesNeeded');
        
        let socket = null;
        let myPlayerId = null;
        let myPlayerName = '';
        let gameState = null;
        
        // Snake colors for different players
        const colors = [
            '#e74c3c', '#3498db', '#2ecc71', '#f39c12', 
            '#9b59b6', '#1abc9c', '#e67e22', '#34495e'
        ];
        
        function connectWebSocket() {
            // Connect to same host and port as HTTP server
            const host = window.location.hostname;
            const port = window.location.port || '666';
            const wsUrl = `ws://${host}:${port}`;
            
            console.log('Connecting to WebSocket:', wsUrl);
            console.log('Player name:', myPlayerName);
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = function() {
                console.log('K·∫øt n·ªëi WebSocket th√†nh c√¥ng t·ªõi:', wsUrl);
                connectionStatus.textContent = 'ƒê√£ k·∫øt n·ªëi';
                connectionStatus.className = 'connected';
                statusDiv.textContent = 'ƒê√£ k·∫øt n·ªëi! Ch·ªù ng∆∞·ªùi ch∆°i kh√°c...';
                
                // Send join message with player name
                const joinMessage = {
                    type: 'join',
                    name: myPlayerName
                };
                console.log('Sending join message:', joinMessage);
                socket.send(JSON.stringify(joinMessage));
            };
            
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'init') {
                    myPlayerId = data.player_id;
                    gameState = data.game_state;
                    updateUI();
                } else if (data.type === 'join_rejected') {
                    // Player cannot join because game is running
                    alert(data.reason);
                    statusDiv.textContent = data.reason;
                    statusDiv.style.color = '#e74c3c';
                    // Show name modal again
                    nameModal.style.display = 'flex';
                    nameInput.value = '';
                    nameInput.focus();
                } else if (data.type === 'game_state') {
                    gameState = data.game_state;
                    updateUI();
                } else if (data.type === 'vote_status') {
                    updateVoteUI(data.vote_status, data.votes);
                } else if (data.type === 'vote_needed') {
                    updateVoteUI(data.vote_status, {});
                } else if (data.type === 'chat') {
                    addChatMessage(data.player_name, data.message);
                } else if (data.type === 'system') {
                    addSystemMessage(data.message);
                }
            };
            
            socket.onclose = function() {
                console.log('WebSocket ƒë√£ ƒë√≥ng');
                connectionStatus.textContent = 'M·∫•t k·∫øt n·ªëi';
                connectionStatus.className = 'disconnected';
                statusDiv.textContent = 'M·∫•t k·∫øt n·ªëi! ƒêang th·ª≠ k·∫øt n·ªëi l·∫°i...';
                
                // Th·ª≠ k·∫øt n·ªëi l·∫°i sau 3 gi√¢y
                setTimeout(connectWebSocket, 3000);
            };
            
            socket.onerror = function(error) {
                console.error('L·ªói WebSocket:', error);
                connectionStatus.textContent = 'L·ªói k·∫øt n·ªëi';
                connectionStatus.className = 'disconnected';
            };
        }
        
        function updateUI() {
            if (!gameState) return;
            
            playerCountSpan.textContent = gameState.player_count;
            
            // Update my score
            const mySnake = gameState.snakes.find(s => s.player_id === myPlayerId);
            if (mySnake) {
                const currentScore = mySnake.score > 0 ? ` (${mySnake.score})` : '';
                myScoreSpan.textContent = `${mySnake.total_score}${currentScore}`;
            }
            
            // Update buttons and voting
            if (gameState.game_started) {
                voteButton.style.display = 'none';
                voteStatus.style.display = 'none';
                startButton.style.display = 'none';
                if (!gameState.game_running) {
                    restartButton.style.display = 'inline-block';
                } else {
                    restartButton.style.display = 'none';
                }
            } else {
                // Show voting interface
                voteButton.style.display = 'inline-block';
                voteStatus.style.display = 'block';
                startButton.style.display = 'none';
                restartButton.style.display = 'none';
                
                // Enable/disable vote button
                const hasVoted = gameState.votes && gameState.votes[myPlayerId];
                voteButton.disabled = hasVoted || gameState.player_count === 0;
                voteButton.textContent = hasVoted ? 'ƒê√£ vote ‚úì' : 'Vote ƒë·ªÉ b·∫Øt ƒë·∫ßu';
                
                // Update vote status
                if (gameState.vote_status) {
                    voteCount.textContent = gameState.vote_status.voted_count;
                    totalPlayers.textContent = gameState.vote_status.total_players;
                    votesNeeded.textContent = gameState.vote_status.votes_needed;
                }
            }
            
            // Update status
            if (!gameState.game_started) {
                if (gameState.player_count === 0) {
                    statusDiv.textContent = 'Ch·ªù ng∆∞·ªùi ch∆°i...';
                } else if (gameState.vote_status && gameState.vote_status.votes_needed > 0) {
                    statusDiv.textContent = `C·∫ßn ${gameState.vote_status.votes_needed} vote n·ªØa ƒë·ªÉ b·∫Øt ƒë·∫ßu game`;
                } else {
                    statusDiv.textContent = 'ƒê·ªß vote! Game s·∫Ω b·∫Øt ƒë·∫ßu...';
                }
            } else if (gameState.game_running) {
                statusDiv.textContent = 'Game ƒëang ch·∫°y!';
                statusDiv.style.color = '#2ecc71';
            } else {
                const aliveSnakes = gameState.snakes.filter(s => s.alive);
                if (aliveSnakes.length === 1) {
                    const winner = aliveSnakes[0];
                    if (winner.player_id === myPlayerId) {
                        statusDiv.textContent = 'Ch√∫c m·ª´ng! B·∫°n th·∫Øng! üéâ';
                        statusDiv.style.color = '#2ecc71';
                    } else {
                        statusDiv.textContent = `Game k·∫øt th√∫c! Ng∆∞·ªùi th·∫Øng: ${winner.player_name}`;
                        statusDiv.style.color = '#e74c3c';
                    }
                } else {
                    statusDiv.textContent = 'Game k·∫øt th√∫c!';
                    statusDiv.style.color = '#e74c3c';
                }
            }
            
            // Update player list
            playersDiv.innerHTML = '';
            gameState.snakes.forEach((snake, index) => {
                const playerDiv = document.createElement('div');
                playerDiv.style.color = colors[index % colors.length];
                const status = snake.alive ? 'üêç' : 'üíÄ';
                const isMe = snake.player_id === myPlayerId ? ' (B·∫°n)' : '';
                const displayName = snake.player_name || snake.player_id;
                const hasVoted = gameState.votes && gameState.votes[snake.player_id];
                const voteCheck = !gameState.game_started && hasVoted ? ' ‚úì' : '';
                const speedBoost = snake.has_speed_boost ? ' ‚ö°' : '';
                const speedReduction = snake.has_speed_reduction ? ' üêå' : '';
                playerDiv.textContent = `${status} ${displayName}${voteCheck}${isMe} - ${snake.score} ƒëi·ªÉm${speedBoost}${speedReduction}`;
                playersDiv.appendChild(playerDiv);
            });
            
            // Update leaderboard
            updateLeaderboard();
            
            // Draw game
            draw();
        }
        
        function updateLeaderboard() {
            if (!gameState) return;
            
            const leaderboardList = document.getElementById('leaderboardList');
            leaderboardList.innerHTML = '';
            
            // Sort snakes by total_score first, then by current score
            const sortedSnakes = [...gameState.snakes].sort((a, b) => {
                if (b.total_score !== a.total_score) {
                    return b.total_score - a.total_score;
                }
                return b.score - a.score;
            });
            
            sortedSnakes.forEach((snake, index) => {
                const rankDiv = document.createElement('div');
                const rankIcon = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
                const isMe = snake.player_id === myPlayerId ? ' (B·∫°n)' : '';
                const displayName = snake.player_name || snake.player_id;
                const status = snake.alive ? '' : ' üíÄ';
                rankDiv.style.color = colors[gameState.snakes.findIndex(s => s.player_id === snake.player_id) % colors.length];
                
                // Show both current score and total score
                const currentScore = snake.score > 0 ? ` (${snake.score})` : '';
                rankDiv.textContent = `${rankIcon} ${displayName}${isMe} - ${snake.total_score}${currentScore}${status}`;
                leaderboardList.appendChild(rankDiv);
            });
        }
        
        function addChatMessage(playerName, message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message chat-player';
            messageDiv.innerHTML = `<strong>${playerName}:</strong> ${message}`;
            chatMessages.appendChild(messageDiv);
            
            // Limit to 10 messages
            while (chatMessages.children.length > 10) {
                chatMessages.removeChild(chatMessages.firstChild);
            }
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function addSystemMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message chat-system';
            messageDiv.textContent = message;
            chatMessages.appendChild(messageDiv);
            
            // Limit to 10 messages
            while (chatMessages.children.length > 10) {
                chatMessages.removeChild(chatMessages.firstChild);
            }
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function draw() {
            if (!gameState) return;
            
            // Clear canvas
            ctx.fillStyle = '#0f1419';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid
            ctx.strokeStyle = '#2c3e50';
            ctx.lineWidth = 0.5;
            for (let x = 0; x <= canvas.width; x += 20) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y <= canvas.height; y += 20) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // Draw food
            gameState.food.forEach(food => {
                let color = '#e74c3c'; // Default red for normal food
                if (food.type === 'white') {
                    color = '#ffffff'; // White food
                } else if (food.type === 'purple') {
                    color = '#9b59b6'; // Purple food
                } else if (food.type === 'black') {
                    color = '#34495e'; // Dark blue-gray food
                } else if (food.type === 'gray') {
                    color = '#95a5a6'; // Gray food
                } else if (food.type === 'gold') {
                    color = '#FFD700'; // Gold food
                } else if (food.type === 'yellow') {
                    color = '#FFFF00'; // Yellow food
                }
                
                ctx.fillStyle = color;
                ctx.fillRect(food.x, food.y, 20, 20);
                // Add glow effect
                ctx.shadowBlur = 10;
                ctx.shadowColor = color;
                ctx.fillRect(food.x + 2, food.y + 2, 16, 16);
                ctx.shadowBlur = 0;
            });
            
            // Draw deadly gold food (if present)
            if (gameState.deadly_gold_food) {
                gameState.deadly_gold_food.forEach(deadlyFood => {
                    ctx.fillStyle = '#FF8C00'; // Dark orange for deadly gold
                    ctx.fillRect(deadlyFood.x, deadlyFood.y, 20, 20);
                    // Add danger glow effect
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = '#FF4500'; // Red-orange glow
                    ctx.fillRect(deadlyFood.x + 2, deadlyFood.y + 2, 16, 16);
                    ctx.shadowBlur = 0;
                    
                    // Add skull symbol for deadly food
                    ctx.fillStyle = '#000000';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('üíÄ', deadlyFood.x + 10, deadlyFood.y + 15);
                });
            }
            
            // Draw snakes
            gameState.snakes.forEach((snake, index) => {
                if (snake.body.length === 0) return;
                
                const color = colors[index % colors.length];
                const isAlive = snake.alive;
                const isMe = snake.player_id === myPlayerId;
                const hasSpeedBoost = snake.has_speed_boost;
                const hasSpeedReduction = snake.has_speed_reduction;
                
                snake.body.forEach((segment, segIndex) => {
                    if (segIndex === 0) {
                        // Snake head
                        ctx.fillStyle = isAlive ? color : '#7f8c8d';
                        ctx.fillRect(segment[0], segment[1], 20, 20);
                        
                        // Head border (golden for own snake, white for speed boost, red for speed reduction)
                        if (isMe) {
                            ctx.strokeStyle = '#f1c40f';
                            ctx.lineWidth = 3;
                        } else if (hasSpeedBoost) {
                            ctx.strokeStyle = '#ffffff';
                            ctx.lineWidth = 3;
                        } else if (hasSpeedReduction) {
                            ctx.strokeStyle = '#e74c3c';
                            ctx.lineWidth = 3;
                        } else {
                            ctx.strokeStyle = '#2c3e50';
                            ctx.lineWidth = 2;
                        }
                        ctx.strokeRect(segment[0], segment[1], 20, 20);
                        
                        // Speed boost glow effect
                        if (hasSpeedBoost && isAlive) {
                            ctx.shadowBlur = 15;
                            ctx.shadowColor = '#ffffff';
                            ctx.strokeStyle = '#ffffff';
                            ctx.lineWidth = 1;
                            ctx.strokeRect(segment[0] - 2, segment[1] - 2, 24, 24);
                            ctx.shadowBlur = 0;
                        }
                        
                        // Speed reduction effect (dark red glow)
                        if (hasSpeedReduction && isAlive) {
                            ctx.shadowBlur = 10;
                            ctx.shadowColor = '#e74c3c';
                            ctx.strokeStyle = '#e74c3c';
                            ctx.lineWidth = 1;
                            ctx.strokeRect(segment[0] - 1, segment[1] - 1, 22, 22);
                            ctx.shadowBlur = 0;
                        }
                        
                        // Eyes
                        if (isAlive) {
                            ctx.fillStyle = '#2c3e50';
                            ctx.fillRect(segment[0] + 5, segment[1] + 5, 3, 3);
                            ctx.fillRect(segment[0] + 12, segment[1] + 5, 3, 3);
                        }
                    } else {
                        // Snake body
                        const alpha = isAlive ? Math.max(0.3, 1 - segIndex * 0.1) : 0.3;
                        ctx.fillStyle = isAlive ? color + Math.round(alpha * 255).toString(16).padStart(2, '0') : '#7f8c8d80';
                        ctx.fillRect(segment[0], segment[1], 20, 20);
                        
                        // Speed boost glow on body
                        if (hasSpeedBoost && isAlive && segIndex < 3) {
                            ctx.shadowBlur = 5;
                            ctx.shadowColor = '#ffffff';
                            ctx.fillRect(segment[0], segment[1], 20, 20);
                            ctx.shadowBlur = 0;
                        }
                        
                        ctx.strokeStyle = '#2c3e50';
                        ctx.lineWidth = 1;
                        ctx.strokeRect(segment[0], segment[1], 20, 20);
                    }
                });
            });
        }
        
        function updateVoteUI(voteStatus, votes) {
            voteCount.textContent = voteStatus.voted_count;
            totalPlayers.textContent = voteStatus.total_players;
            votesNeeded.textContent = voteStatus.votes_needed;
            
            // Update vote button
            const hasVoted = votes && votes[myPlayerId];
            voteButton.disabled = hasVoted;
            voteButton.textContent = hasVoted ? 'ƒê√£ vote ‚úì' : 'Vote ƒë·ªÉ b·∫Øt ƒë·∫ßu';
        }
        
        // Event handlers
        voteButton.addEventListener('click', function() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'vote_start'
                }));
            }
        });
        
        startButton.addEventListener('click', function() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'start_game'
                }));
            }
        });
        
        restartButton.addEventListener('click', function() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'restart_game'
                }));
            }
        });
        
        // Name input handlers
        joinButton.addEventListener('click', function() {
            const name = nameInput.value.trim();
            console.log('Join button clicked, name:', name);
            if (name.length > 0) {
                myPlayerName = name;
                console.log('Player name set to:', myPlayerName);
                nameModal.style.display = 'none';
                connectWebSocket();
            } else {
                console.log('Name is empty, cannot join');
                alert('Vui l√≤ng nh·∫≠p t√™n!');
            }
        });
        
        nameInput.addEventListener('keypress', function(event) {
            console.log('Key pressed:', event.key);
            if (event.key === 'Enter') {
                console.log('Enter key pressed, triggering join');
                joinButton.click();
            }
        });
        
        // Chat handlers
        chatInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                const message = chatInput.value.trim();
                if (message.length > 0 && socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        type: 'chat',
                        message: message
                    }));
                    chatInput.value = '';
                }
            }
        });
        
        // Keyboard controls
        document.addEventListener('keydown', function(event) {
            if (!socket || socket.readyState !== WebSocket.OPEN || !gameState || !gameState.game_running) {
                return;
            }
            
            // Get current player's snake
            const mySnake = gameState.snakes.find(s => s.player_id === myPlayerId);
            if (!mySnake || !mySnake.alive) {
                return;
            }
            
            let direction = null;
            
            switch(event.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    direction = 'up';
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    direction = 'down';
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    direction = 'left';
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    direction = 'right';
                    break;
            }
            
            if (direction) {
                // Prevent reverse direction on client side
                const opposite = {
                    'up': 'down',
                    'down': 'up',
                    'left': 'right',
                    'right': 'left'
                };
                
                // Additional check: if snake has more than 1 segment, 
                // don't allow direction that would immediately hit the second segment
                let canChangeDirection = true;
                if (mySnake.body.length > 1) {
                    const head = mySnake.body[0];
                    const second = mySnake.body[1];
                    
                    // Calculate where the head would be after the move
                    let newHead = null;
                    if (direction === 'up') {
                        newHead = [head[0], head[1] - 20];
                    } else if (direction === 'down') {
                        newHead = [head[0], head[1] + 20];
                    } else if (direction === 'left') {
                        newHead = [head[0] - 20, head[1]];
                    } else if (direction === 'right') {
                        newHead = [head[0] + 20, head[1]];
                    }
                    
                    // Don't allow if new head would be on second segment
                    if (newHead && newHead[0] === second[0] && newHead[1] === second[1]) {
                        canChangeDirection = false;
                    }
                }
                
                // Only send if direction is valid
                if (direction !== opposite[mySnake.direction] && canChangeDirection) {
                    event.preventDefault();
                    socket.send(JSON.stringify({
                        type: 'move',
                        direction: direction
                    }));
                }
            }
        });
        
        // Focus name input when page loads
        nameInput.focus();
    </script>
</body>
</html>
